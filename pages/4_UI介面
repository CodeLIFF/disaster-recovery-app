import streamlit as st
import pandas as pd
import gspread
from google.oauth2.service_account import Credentials

# ---------------- Google Sheet é€£ç·š ----------------
SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
]

creds = Credentials.from_service_account_info(
    st.secrets["google"],
    scopes=SCOPES
)

gc = gspread.authorize(creds)

# Google Sheet ID
SHEET_ID = "1PbYajOLCW3p5vsxs958v-eCPgHC1_DnHf9G_mcFx9C0"
sheet = gc.open_by_key(SHEET_ID).sheet1

data = sheet.get_all_records()
df = pd.DataFrame(data)

# ---------------- Streamlit UI ----------------
st.set_page_config(page_title="ç½å¾Œåª’åˆå¹³å°", layout="wide")
st.title("ç½å¾ŒäººåŠ›åª’åˆå¹³å°ï¼ˆå¿—å·¥ x å—ç½æˆ¶ï¼‰")
st.write(f"ç›®å‰å…±æœ‰ {len(df)} ç­†éœ€æ±‚")

# ---------------- ç¯©é¸å€ ----------------
col1, col2, col3 = st.columns(3)

keyword = col1.text_input("æœå°‹åœ°å€æˆ–å‚™è¨»")
skill_filter = col2.selectbox("èƒ½åŠ›éœ€æ±‚", ["å…¨éƒ¨"] + sorted(df["skills"].unique()))
need_filter = col3.selectbox("åé¡ç‹€æ…‹", ["å…¨éƒ¨", "æœªæ»¿", "å·²æ»¿"])

filtered = df.copy()

# æ–‡å­—æœå°‹
if keyword:
    filtered = filtered[
        filtered["address"].str.contains(keyword, case=False) |
        filtered["note"].str.contains(keyword, case=False)
    ]

# èƒ½åŠ›éœ€æ±‚
if skill_filter != "å…¨éƒ¨":
    filtered = filtered[filtered["skills"] == skill_filter]

# æ˜¯å¦å·²æ»¿
if need_filter == "æœªæ»¿":
    filtered = filtered[filtered["selected_people"] < filtered["need_people"]]
elif need_filter == "å·²æ»¿":
    filtered = filtered[filtered["selected_people"] >= filtered["need_people"]]

st.markdown("---")

# ---------------- è³‡æ–™å¡ç‰‡åˆ—è¡¨ ----------------

for idx, row in filtered.iterrows():

    left, right = st.columns([2, 1])

    # å·¦é‚Šï¼šæ–‡å­—è³‡è¨Š
    with left:
        st.markdown(f"## ğŸ“ {row['address']}")
        st.markdown(f"**ğŸ•’ å·¥ä½œæ™‚é–“ï¼š** {row['work_time']}")
        st.markdown(f"**ğŸ‘¥ éœ€æ±‚äººæ•¸ï¼š** {row['selected_people']} / {row['need_people']}")
        st.markdown(f"**ğŸ§° æä¾›è³‡æºï¼š** {row['resources']}")
        st.markdown(f"**ğŸ’ª èƒ½åŠ›éœ€æ±‚ï¼š** {row['skills']}")
        st.markdown(f"**ğŸš— å»ºè­°äº¤é€šæ–¹å¼ï¼š** {row['transport']}")
        st.markdown(f"**ğŸ“ å‚™è¨»ï¼š** {row['note']}")

        # å ±åæŒ‰éˆ•
        st.link_button("æˆ‘è¦å ±å", f"https://forms.gle/xxxxxxx")

    # å³é‚Šï¼šå¯¦æ™¯ç…§ç‰‡
    with right:
        if row["photo_url"]:
            st.image(row["photo_url"], use_column_width=True)
        else:
            st.write("(ç„¡ç…§ç‰‡)")

    st.markdown("---")

